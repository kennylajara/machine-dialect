# Machine Dialect™ CFG Module

This module provides Context Free Grammar (CFG) support for Machine Dialect™, enabling structured
generation with GPT-5's CFG capabilities.

## Features

- **Lark-based Parser**: Fast LALR parser for validating Machine Dialect™ syntax
- **GPT-5 Integration**: Ready-to-use CFG schema for structured generation (GPT-5 only)
- **Simplified Grammar**: Covers core language features:
  - Variable assignment (`Set` statements)
  - Output (`Say` statements)
  - Conditionals (`if`/`else`)
  - Mathematical operations (`+`, `-`, `*`, `/`)
  - Logical operations (`and`, `or`, `not`)
  - Comparisons (symbolic and natural language)

## Installation

The module uses Lark, which was already added to dependencies:

```bash
uv sync
```

## Usage

### Parsing Machine Dialect™ Code

```python
from machine_dialect.cfg import CFGParser

parser = CFGParser()

# Parse code
code = """
Set `x` to 10.
Set `y` to 20.
Say x + y.
"""

tree = parser.parse(code)
print(parser.pretty_print(tree))

# Validate code
is_valid = parser.validate(code)
```

### Generating with GPT-5 CFG

```python
from machine_dialect.cfg import CFGGenerator
from machine_dialect.cfg.generator import GenerationConfig

generator = CFGGenerator()

# Create a prompt
task = "Calculate the factorial of 5"
prompt = generator.create_prompt(task)

# Configure generation
config = GenerationConfig(
    max_tokens=200,
    temperature=0.3,
    seed=42
)

# Create GPT-5 request with CFG constraints
request = generator.generate_with_cfg(prompt, config)

# The request includes the CFG schema that ensures
# GPT-5 generates syntactically valid Machine Dialect™ code
```

### Validating Generated Code

```python
# Validate code generated by GPT-5
code = """
Set `result` to 5 * 4 * 3 * 2 * 1.
Say result.
"""

is_valid, error = generator.validate_generated_code(code)
if is_valid:
    print("Code is valid!")
else:
    print(f"Validation error: {error}")
```

## Grammar Structure

The grammar is defined in `grammar.lark` using Lark's EBNF-like syntax:

- **Statements**: `set_statement`, `say_statement`, `if_statement`
- **Expressions**: Support for operator precedence
- **Literals**: Integers, floats, strings, booleans, `empty`
- **Identifiers**: Must be wrapped in backticks in statements

## CFG Schema for GPT-5

The module generates a CFG schema compatible with GPT-5's structured generation:

```python
# Save the schema for inspection
generator.save_cfg_schema("schema.json")
```

The schema defines production rules that GPT-5 uses to ensure generated text follows Machine
Dialect syntax exactly.

## Running Examples

```bash
# Run all examples
python -m machine_dialect.cfg.examples

# Run tests
python -m pytest machine_dialect/cfg/tests/
```

## Integration with GPT-5

When GPT-5 becomes available, use the generated request structure:

```python
import openai

# Set up OpenAI client (when available)
client = openai.Client(api_key="your-key")

# Use the request from CFGGenerator
response = client.chat.completions.create(**request)
generated_code = response.choices[0].message.content

# Validate the generated code
is_valid, error = generator.validate_generated_code(generated_code)
```

## Limitations

This simplified grammar doesn't include:

- Actions and Interactions
- Block syntax with `>` markers
- Double-asterisk keywords
- URL literals
- Complex parameter definitions

These can be added by extending `grammar.lark` as needed.
